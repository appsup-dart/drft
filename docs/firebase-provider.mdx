# Firebase Provider (`drft_firebase`)

The Firebase provider enables DRFT to manage Firebase projects, apps, and services - essential infrastructure for Flutter applications.

## Why Firebase Provider?

- **Flutter Ecosystem**: Most Flutter apps use Firebase for backend services
- **Comprehensive Configuration**: Projects, apps, authentication, databases, storage
- **Terraform Gap**: Limited Firebase support in Terraform
- **High Value**: Solves real pain points for Flutter developers

## Installation

```yaml
# pubspec.yaml
dependencies:
  drft: ^1.0.0
  drft_firebase: ^1.0.0
```

## Configuration

```dart
import 'package:drft/drft.dart';
import 'package:drft_firebase/drft_firebase.dart';

final provider = FirebaseProvider(
  projectId: 'my-project-id',
  credentials: FirebaseCredentials.fromServiceAccount('path/to/service-account.json'),
  // Or from environment
  // credentials: FirebaseCredentials.fromEnvironment(),
);
```

## Resources

### Firebase Project

```dart
FirebaseProject(
  name: 'my-firebase-project',
  projectId: 'my-project-id',
  displayName: 'My Firebase Project',
)
```

### Firebase App

```dart
FirebaseApp(
  name: 'ios-app',
  projectId: project.id,
  platform: 'ios',
  bundleId: 'com.example.app',
  appStoreId: '1234567890', // Optional
)

FirebaseApp(
  name: 'android-app',
  projectId: project.id,
  platform: 'android',
  packageName: 'com.example.app',
  sha1Fingerprints: ['AA:BB:CC:...'], // Optional
)

FirebaseApp(
  name: 'web-app',
  projectId: project.id,
  platform: 'web',
  appId: 'web-app-id',
)
```

### Firebase Authentication

```dart
FirebaseAuth(
  projectId: project.id,
  enabledProviders: [
    'email',
    'google',
    'apple',
    'facebook',
    'twitter',
  ],
  emailVerification: true,
  emailLinkSignIn: true,
  anonymousSignIn: true,
  multiFactorAuth: MultiFactorAuth(
    enabled: true,
    providers: ['phone'],
  ),
  passwordPolicy: PasswordPolicy(
    minLength: 8,
    requireUppercase: true,
    requireLowercase: true,
    requireNumbers: true,
    requireSpecialChars: true,
  ),
)
```

### Firestore Database

```dart
FirestoreDatabase(
  name: 'main-database',
  projectId: project.id,
  location: 'us-central',
  mode: 'FIRESTORE_NATIVE', // or 'DATASTORE_MODE'
  rules: '''
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /{document=**} {
          allow read, write: if request.auth != null;
        }
      }
    }
  ''',
  indexes: [
    FirestoreIndex(
      collection: 'users',
      fields: [
        IndexField(field: 'email', order: 'ASCENDING'),
        IndexField(field: 'createdAt', order: 'DESCENDING'),
      ],
    ),
  ],
)
```

### Cloud Storage

```dart
CloudStorageBucket(
  name: 'app-storage',
  projectId: project.id,
  location: 'us-central',
  storageClass: 'STANDARD',
  rules: '''
    rules_version = '2';
    service firebase.storage {
      match /b/{bucket}/o {
        match /{allPaths=**} {
          allow read: if request.auth != null;
          allow write: if request.auth != null 
            && request.resource.size < 5 * 1024 * 1024; // 5MB limit
        }
      }
    }
  ''',
)
```

### Remote Config

```dart
RemoteConfig(
  name: 'app-config',
  projectId: project.id,
  parameters: {
    'api_url': RemoteConfigParameter(
      defaultValue: 'https://api.example.com',
      description: 'API endpoint URL',
    ),
    'feature_enabled': RemoteConfigParameter(
      defaultValue: 'false',
      valueType: 'boolean',
    ),
  },
  conditions: [
    RemoteConfigCondition(
      name: 'ios',
      expression: 'device.os == "ios"',
    ),
  ],
)
```

### App Check

```dart
AppCheck(
  projectId: project.id,
  iosAppId: iosApp.id,
  androidAppId: androidApp.id,
  webAppId: webApp.id,
  iosProvider: AppCheckProvider.appAttest(
    appleAppAttestKeyId: 'key-id',
  ),
  androidProvider: AppCheckProvider.playIntegrity(),
  webProvider: AppCheckProvider.recaptcha(
    siteKey: 'recaptcha-site-key',
  ),
)
```

## Complete Example

```dart
import 'package:drft/drft.dart';
import 'package:drft_firebase/drft_firebase.dart';

void main() async {
  final stack = DrftStack(
    name: 'flutter-app-backend',
    providers: [
      FirebaseProvider(
        projectId: 'my-flutter-app',
        credentials: FirebaseCredentials.fromServiceAccount('service-account.json'),
      ),
    ],
    resources: [
      // Firebase Project
      FirebaseProject(
        name: 'my-project',
        projectId: 'my-flutter-app',
        displayName: 'My Flutter App Backend',
      ),
      
      // Firebase Apps
      FirebaseApp(
        name: 'ios-app',
        projectId: project.id,
        platform: 'ios',
        bundleId: 'com.example.app',
      ),
      
      FirebaseApp(
        name: 'android-app',
        projectId: project.id,
        platform: 'android',
        packageName: 'com.example.app',
      ),
      
      FirebaseApp(
        name: 'web-app',
        projectId: project.id,
        platform: 'web',
      ),
      
      // Authentication
      FirebaseAuth(
        projectId: project.id,
        enabledProviders: ['email', 'google', 'apple'],
        emailVerification: true,
      ),
      
      // Firestore Database
      FirestoreDatabase(
        name: 'main-db',
        projectId: project.id,
        location: 'us-central',
        rules: firestoreRules,
      ),
      
      // Cloud Storage
      CloudStorageBucket(
        name: 'app-storage',
        projectId: project.id,
        location: 'us-central',
        rules: storageRules,
      ),
      
      // Remote Config
      RemoteConfig(
        name: 'app-config',
        projectId: project.id,
        parameters: {
          'api_url': RemoteConfigParameter(
            defaultValue: 'https://api.example.com',
          ),
        },
      ),
    ],
  );
  
  final plan = await stack.plan();
  await stack.apply(plan);
}
```

## Implementation Notes

### Authentication

The Firebase provider uses the Firebase Admin SDK for server-side operations:
- Service account JSON file
- Environment variables
- Application Default Credentials (ADC)

### API Limitations

- Some Firebase resources have rate limits
- Some operations are asynchronous and may take time
- Some resources require specific project configurations

### State Management

Firebase resources are tracked by their resource IDs:
- Projects: `projects/{project_id}`
- Apps: `projects/{project_id}/apps/{app_id}`
- Databases: `projects/{project_id}/databases/{database_id}`

## Resources Roadmap

### Phase 1 (Initial)
- âœ… Firebase Projects
- âœ… Firebase Apps (iOS, Android, Web)
- âœ… Firebase Authentication
- âœ… Firestore Databases
- âœ… Cloud Storage Buckets

### Phase 2
- ðŸŽ¯ Remote Config
- ðŸŽ¯ App Check
- ðŸŽ¯ Cloud Functions configuration
- ðŸŽ¯ Cloud Messaging (FCM)
- ðŸŽ¯ Realtime Database

### Phase 3
- ðŸŽ¯ Firebase Extensions
- ðŸŽ¯ Firebase Hosting
- ðŸŽ¯ Cloud Firestore Indexes
- ðŸŽ¯ IAM roles and permissions

